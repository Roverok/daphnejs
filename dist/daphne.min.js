/*! daphne 2014-09-11 */
define(["d3"],function(a){"use strict";function b(a,b){return this.el="string"==typeof a?document.querySelector(a):a,this.options=b||{},null===this.el?this:(this.init(),this)}return b.prototype.defaults={mode:"edit",lang:"grc",data:null,marginTop:30,marginRight:0,marginBottom:50,marginLeft:0,width:400,height:400,initialScale:.9,duration:500,include:null,exclude:null,config:null},b.prototype.init=function(){return this.config=this._extend({},this.defaults,this.options),this._configureSettings(this.options.config),this.data=this._convertData(this.config.data),this.render(),this},b.prototype._configureSettings=function(a){if("string"==typeof a){var b=new XMLHttpRequest;b.responseType="json",b.open("GET",a,!1),b.onload=function(){b.status>=200&&b.status<400?this.config.config=b.response:console.log("Reached server but server error occured while trying to fetch data")}.bind(this),b.onerror=function(){console.log("Connection error while trying to fetch data.")},b.send()}else"object"==typeof a?this.config.config=a:"undefined"==typeof a&&(this.config.config={fields:[{name:"value",type:"text",label:"Value"},{name:"pos",type:"text",label:"Part of Speech"},{name:"relation",type:"text",label:"Relation"}]})},b.prototype._fetchData=function(){var a=new XMLHttpRequest;a.responseType="json",a.open("GET",this.config.dataSource,!0),a.onload=function(){if(a.status>=200&&a.status<400){this.data=this._convertData(a.response.words);var b;window.CustomEvent?b=new CustomEvent("populated"):(b=document.createEvent("CustomEvent"),b.initEvent("populated",!0,!0)),this.el.dispatchEvent(b)}else console.log("Reached server but server error occured while trying to fetch data")}.bind(this),a.onerror=function(){console.log("Connection error while trying to fetch data.")},a.send()},b.prototype._convertData=function(a){this.answers=JSON.parse(JSON.stringify(a));for(var b=a.reduce(function(a,b){return a[b.id]=b,a},[]),c=0,d=0;d<a.length;d++){var e=a[d];if(void 0===b[e.head]){c=e.head;var f={id:c,value:"root",pos:"root",relation:""};a.push(f),b[c]=f;break}}"play"==this.config.mode&&(Object.keys(b).forEach(function(a){"root"!==b[a].pos&&(b[a].head=c)}),a.forEach(function(a){"root"!==a.pos&&(a.head=c)}));var g=[];return a.forEach(function(a){var c=b[a.head];c?(c.children||(c.children=[])).push(a):g.push(a)}),g},b.prototype.render=function(){if(-1===this.el.className.indexOf("daphne")&&(this.el.className+=" daphne"),this.el.innerHTML="",this.header=document.createElement("div"),this.header.className="sentence",this.el.appendChild(this.header),"play"==this.config.mode){this.tracker=document.createElement("div"),this.tracker.className="tracker";var b=document.createElement("span");b.className="points wiggle",b.innerHTML="0";var c=document.createElement("span");c.className="feedback",c.innerHTML="Make your move!",this.tracker.appendChild(b),this.tracker.appendChild(c),this.el.appendChild(this.tracker),this._delayAddClass(c,"hidden",3e3),this._delayRemoveClass(b,"wiggle",3e3)}this.footer=document.createElement("div"),this.footer.className="footer",this.el.appendChild(this.footer);for(var d=0;d<this.answers.length;d++){var e=document.createElement("span"),f=document.createTextNode(" ");e.innerHTML=this.answers[d].value,e.setAttribute("data-id",this.answers[d].id),this.header.appendChild(e),this.header.appendChild(f)}this.tree=a.layout.tree().nodeSize([100,50]),this.tree.separation(function(a,b){var c=a.value.length>a.relation.length?a.value.length:a.relation.length,d=b.value.length>b.relation.length?b.value.length:b.relation.length,e=.1;return c*e+d*e/2}),this.color=a.scale.ordinal().domain(["noun","verb","participle","adj","adverb","particle","conj","prep","pron","numeral","interjection","exclam","punct","article","root","_","unassigned"]).range(["#019292","#D15241","#8CD141","#4E6087","#8CD141","#FF881A","#754574","#149069","#523D5B","#812F0F","#F4BC78","#F4BC78","#1D78AA","#257008","#333","#999","#999"]),this.svg=a.select(this.el).append("svg").attr("class","svg-container"),this.canvas=this.svg.append("g").attr("class","canvas"),this.canvas.append("g"),this.canvas.attr("transform","translate("+this.config.width/2+", "+this.config.marginTop+") scale(0.9)"),a.select(this.el.querySelector("svg")).call(a.behavior.zoom().scaleExtent([.5,5]).on("zoom",this._zoom.bind(this))).on("dblclick.zoom",null),this._addEvent(window,"resize",this._respond.bind(this)),this.root=this.data[0],this._update(this.root)},b.prototype._respond=function(){var a=this.el.offsetWidth-70;this.el.querySelector("svg").style.width=a+"px",this.canvas.attr("transform","translate("+a/2+", "+this.config.marginTop+") scale(0.9)"),this.config.width=this.el.offsetWidth},b.prototype._zoom=function(){this.config.width=this.el.offsetWidth;var b=a.event.scale,c=a.event.translate,d=-this.config.height*b,e=this.config.height*b,f=(-this.config.width+this.config.marginRight)*b,g=(this.config.width+this.config.marginLeft)*b,h=[Math.max(Math.min(c[0],g),f),Math.max(Math.min(c[1],e),d)];this.canvas.attr("transform","translate("+h+") scale("+b+")")},b.prototype._update=function(b){var c=this,d=a.svg.diagonal().projection(function(a){return[a.x,a.y]}),e=this.tree(this.root).reverse(),f=this.tree.links(e),g=0;e.forEach(function(a){g=a.depth>g?a.depth:g,a.y=100*a.depth});var h=100*g+200+"px";this.el.style.maxHeight=h,this.el.querySelector("svg").style.height=h;var i=this.svg.select(".canvas g").selectAll("g.node").data(e,function(a){return a.id}),j=i.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+b.x+", "+b.y+")"});j.append("circle").attr("r",10).on("click",function(b,d){c._clickNode(b,d,a.select(this))}).on("dblclick",function(b,d){c._viewNodeProperties(b,d,a.select(this))}).style("stroke",function(a){return c.color(a.pos)}),j.append("text").attr("y",function(a){return"root"==a.pos?-30:15}).attr("dy","14px").attr("lang",function(){return c.config.lang}).attr("text-anchor","middle").text(function(a){return a.value}).style("fill",function(a){return"root"==a.pos?"#CCC":"#333"}),j.append("text").attr("y",function(a){return"root"==a.pos?0:-30}).attr("dy","12px").attr("text-anchor","middle").attr("class","label").text(function(a){return a.relation});var k=i.transition().duration(this.config.duration).attr("transform",function(a){return"translate("+a.x+", "+a.y+")"});k.select("text.label").text(function(a){return a.relation}),k.select("circle").style("stroke",function(a){return c.color(a.pos)}).style("fill",function(b){return a.select(this).classed("match")?a.rgb(c.color(b.pos)).brighter():"#FFF"});var l=this.svg.select(".canvas g").selectAll("path.link").data(f,function(a){return a.target.id});l.enter().insert("path","g").attr("class","link").style("stroke","#CCC").style("stroke-width","2px").style("fill","none").attr("d",function(){var a={x:b.x,y:b.y};return d({source:a,target:a})}),l.transition().duration(this.config.duration).attr("d",d),e.forEach(function(a){a.x0=a.x,a.y0=a.y})},b.prototype._deselectNode=function(a,b){b.classed({selected:!1}),"root"!==a.pos&&(this.el.querySelector('span[data-id="'+a.id+'"]').className="")},b.prototype._selectNode=function(a,b){b.classed({selected:!0}),"root"!==a.pos&&(this.el.querySelector('span[data-id="'+a.id+'"]').className="selected")},b.prototype._deselectAllNodes=function(){var b=[];this.svg.selectAll("circle").each(function(c){b.push({d:c,node:a.select(this)})}),setTimeout(function(){for(var a=0;a<b.length;a++)this._deselectNode(b[a].d,b[a].node)}.bind(this),500)},b.prototype._clickNode=function(b,c,d){if(d.classed("selected"))return void this._deselectNode(b,d);this.footer.classList.contains("open")&&this._viewNodeProperties(b,c,d),this._selectNode(b,d);var e=[];if(this.svg.selectAll("circle").each(function(b){a.select(this).classed("selected")&&e.push(b)}),2==e.length){var f=b,g=f.id!=e[0].id?e[0]:e[1];if(this._validMove(g,f)&&(f.children=this._insertChild(f.children,g),g.parent.children=this._removeChild(g.parent.children,g),g.parent=f,g.head=f.id,this._update(f),"play"==this.config.mode)){var h=this.svg.selectAll("circle").filter(function(a){return a.id==g.id}),i=this._checkMatch(g,f);h.classed({match:i}),this._update(h),this._sendSubmission(g,i),this._checkCompletion()&&this._sendSubmission(g,i,!0)}this._deselectAllNodes()}},b.prototype._sendSubmission=function(a,b,c){var d,e=c?"completed":"submitted";if(window.CustomEvent){var f=_.clone(a);f.parent=a.parent.id,f.children=_.pluck(a.children,"id");var g={detail:{accuracy:b?100:0,task:"build_parse_tree",response:f}};a.CTS&&(g.detail.encounteredWords=[a.CTS]),d=new CustomEvent(e,g)}else d=document.createEvent(e);this.el.dispatchEvent(d)},b.prototype._viewNodeProperties=function(a,b){null===this.footer.querySelector("form")&&this._renderForm();for(var c=this.config.config.fields,d=0;d<c.length;b++){var e=this.footer.querySelector('[name="'+c[d].name+'"]'),f=a.hasOwnProperty(c[d].name)?a[c[d].name]:"";switch(e.tagName){default:e.value=f}}this.footer.className="footer open",this.el.querySelector(".form-footer").style.display="block",this._showFields()},b.prototype._hideNodeProperties=function(a){a&&a.preventDefault(),this.footer.className="footer",this.el.querySelector(".form-footer").style.display="none"},b.prototype._renderForm=function(){for(var a=document.createElement("form"),b=this.config.config.fields,c=0;c<b.length;c++){var d=document.createElement("div");d.setAttribute("data-name",b[c].name);var e=document.createElement("label");e.innerHTML=b[c].label,e.setAttribute("for",b[c].name),d.appendChild(e);var f;switch(b[c].type){case"text":f=document.createElement("input"),f.type="text";break;case"select":f=document.createElement("select");var g=document.createElement("option");g.innerHTML="Select "+b[c].label,g.value="",f.appendChild(g);break;default:f=document.createElement(b[c].type)}f.name=b[c].name,"pos"==b[c].name&&(f.onchange=this._showFields.bind(this));for(var h in b[c].options)if(b[c].options.hasOwnProperty(h)){var i=document.createElement("option");i.innerHTML=b[c].options[h],i.value=h,f.appendChild(g)}d.appendChild(f),a.appendChild(d)}var j=document.createElement("div");j.className="form-footer";var k=document.createElement("a");k.href="#",k.className="save-link",k.appendChild(document.createTextNode("Save Word"));var l=document.createElement("a");l.href="#",l.className="cancel-link",l.appendChild(document.createTextNode("Cancel")),l.onclick=this._hideNodeProperties.bind(this),j.appendChild(l),j.appendChild(k),this.footer.appendChild(a),this.el.appendChild(j)},b.prototype._showFields=function(){for(var a=this.footer.querySelector("form"),b=a.querySelector('select[name="pos"]'),c=b.options[b.selectedIndex].value,d=a.querySelectorAll("[data-name]"),e={},f=this.config.config.fields,g=0,h=f.length;h>g;g++)e[f[g].name]=f[g];for(g=0;g<d.length;g++){var i=d[g].getAttribute("data-name");d[g].className=e[i].exclude&&-1!==e[i].exclude.indexOf(c)?"hidden":e[i].include&&-1!==e[i].include.indexOf(c)?"shown":e[i].include&&-1===e[i].include.indexOf(c)?"hidden":"shown"}},b.prototype._editNode=function(){},b.prototype._validMove=function(a,b){return b.id===a.parent.id?(console.log("Child is already assigned to this parent."),!1):"root"===a.pos?(console.log("Cannot move root."),!1):this._isAncestor(a,b.id)?(console.log("Cannot make an ancestor the child of one of its descendants."),!1):(console.log("Valid Move"),!0)},b.prototype._getMaxDepth=function(a,b){var c=a.children;if(c)for(var d=0,e=c.length;e>d;d++)return b>c[d].depth?b:this._getMaxDepth(c[d],b)},b.prototype._isAncestor=function(a,b){var c=a.children;if(c)for(var d=0,e=c.length;e>d;d++){if(c[d].id==b)return!0;if(this._isAncestor(c[d],b))return!0}return!1},b.prototype._insertChild=function(a,b){a||(a=[]);var c=0;for(c;c<a.length&&!(a[c].id>b.id);c++);return a.splice(c,0,b),a},b.prototype._removeChild=function(a,b){var c=0;for(c;c<a.length&&a[c].id!=b.id;c++);return a.splice(c,1),a},b.prototype._checkMatch=function(a,b){if(!this.answers)return console.log("Cannot check connection without data to check against."),!1;for(var c,d=0;d<this.answers.length;d++)if(a.id==this.answers[d].id){c=b.id===this.answers[d].head;break}return this._updateScore(a,c,!1),c},b.prototype._checkCompletion=function(){var b=!0,c=this,d=[],e=[],f=this.answers.reduce(function(a,b){return a[b.id]=b,a},[]);if(this.svg.selectAll("circle").each(function(a){"root"!==a.pos&&(b=a.parent.id==f[a.id].head&&b?!0:!1,a.parent.id==c.root.id&&(d.push(this),e.push(a)))}),b)for(var g=0;g<d.length;g++)a.select(d[g]).classed({match:!0}),this._update(e[g]),this._updateScore(e[g],!0,!0);return b},b.prototype._updateScore=function(a,b,c){void 0===this.correct&&(this.correct=[]);var d=this.tracker.querySelector(".points"),e=this.tracker.querySelector(".feedback");if(b&&-1===this.correct.indexOf(a))this.correct.push(a),d.innerHTML=parseInt(d.innerHTML)+1,e.innerHTML=c?"Complete!!":"Super!",this._delayAddClass(d,"success bounce",0),this._delayRemoveClass(d,"success bounce",3e3);else if(b||-1===this.correct.indexOf(a))e.innerHTML="Try again!",this._delayAddClass(d,"error wiggle",0),this._delayRemoveClass(d,"error wiggle",3e3);else{d.innerHTML=parseInt(d.innerHTML)-1;var f=this.correct.indexOf(a);this.correct.splice(f,1),e.innerHTML="You might want to put that back.",this._delayAddClass(d,"error wiggle",0),this._delayRemoveClass(d,"error wiggle",3e3)}this._delayRemoveClass(e,"hidden",0),this._delayAddClass(e,"hidden",3e3)},b.prototype._extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},b.prototype._delayAddClass=function(a,b,c){setTimeout(function(){-1===a.className.indexOf(b)&&(a.className+=" "+b)},c)},b.prototype._delayRemoveClass=function(a,b,c){setTimeout(function(){if(-1===b.indexOf(" "))a.removeClass(b);else for(var c=b.split(" "),d=0;d<c.length;d++)a.removeClass(c[d])},c)},b.prototype._addEvent=function(a,b,c){null!==a&&"undefined"!=typeof a&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c)},HTMLElement.prototype.removeClass||(HTMLElement.prototype.removeClass=function(a){for(var b="",c=this.className.split(" "),d=0;d<c.length;d++)c[d]!==a&&(b+=c[d]+" ");this.className=b.trim()}),Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}a.prototype=window.Event.prototype,window.CustomEvent=a}(),b});