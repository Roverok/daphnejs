/*! daphne 2014-06-17 */
define(["d3"],function(a){"use strict";function b(a,b){return this.el=document.querySelector(a),this.options=b||{},null===this.el?(console.log("Could not find DOM object"),this):(this.el.className="daphne",this.header=document.createElement("div"),this.header.className="sentence",this.el.appendChild(this.header),this.init(),this)}return b.prototype.defaults={mode:"edit",lang:"grc",source:"http://monicalent.com/daphne/demo/data.json",dimensions:{margins:{top:50,right:0,bottom:50,left:0},width:600,height:600,initialScale:.9},duration:500},b.prototype.init=function(){return this.config=this._extend({},this.defaults,this.options),this.config.data?this.data=this._convertData(this.config.data):(this.el.addEventListener("populated",this.render.bind(this)),this._fetchData()),this},b.prototype._extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},b.prototype._fetchData=function(){var a=new XMLHttpRequest;a.open("GET",this.config.source,!0),a.onload=function(){if(a.status>=200&&a.status<400){this.data=this._convertData(JSON.parse(a.responseText).words);var b;window.CustomEvent?b=new CustomEvent("populated"):(b=document.createEvent("CustomEvent"),b.initEvent("populated",!0,!0)),this.el.dispatchEvent(b)}else console.log("Reached server but server error occured while trying to fetch data")}.bind(this),a.onerror=function(){console.log("Connection error while trying to fetch data.")},a.send()},b.prototype._convertData=function(a){var b=this;this.answers=JSON.parse(JSON.stringify(a));for(var c=a.reduce(function(a,b){return a[b.id]=b,a},{}),d={},e=0;e<a.length&&(d=a[e],void 0!==c[d.head]);e++);var f={id:d.head,value:"root",pos:"root"};a.push(f),c[d.head]=f;var g=[];return a.forEach(function(a){var d="play"==b.config.mode&&"root"!=a.pos?c[f.id]:c[a.head];d?(d.children||(d.children=[])).push(a):g.push(a)}),g},b.prototype.render=function(){for(var b=this,c=0;c<this.answers.length;c++){var d=document.createElement("span"),e=document.createTextNode(" ");d.innerHTML=this.answers[c].value,d.setAttribute("data-id",this.answers[c].id),this.header.appendChild(d),this.header.appendChild(e)}this.tree=a.layout.tree().nodeSize([100,50]),this.tree.separation(function(a,b){var c=a.value.length>a.relation.length?a.value.length:a.relation.length,d=b.value.length>b.relation.length?b.value.length:b.relation.length,e=.13;return Math.ceil(c*e+d*e/2)}),this.color=a.scale.ordinal().domain(["noun","verb","participle","adj","adverb","particle","conj","prep","pron","numeral","interjection","exclam","punct","article","root","_","unassigned"]).range(["#019292","#D15241","#8CD141","#4E6087","#8CD141","#FF881A","#754574","#149069","#523D5B","#812F0F","#F4BC78","#F4BC78","#1D78AA","#257008","#333","#999","#999"]),this.svg=a.select(this.el).append("svg").attr("class","svg-container").style("width","100%").style("overflow","auto"),this.canvas=this.svg.append("g").attr("class","canvas"),this.canvas.append("g").attr("transform","translate("+b.config.dimensions.width+", "+b.config.dimensions.margins.top+") scale("+b.config.dimensions.initialScale+")"),a.select(this.el.querySelector("svg")).call(a.behavior.zoom().scaleExtent([.5,5]).on("zoom",this._zoom.bind(this))).on("dblclick.zoom",null),this.root=this.data[0],this._update(this.root)},b.prototype._zoom=function(){var b=a.event.scale,c=a.event.translate,d=-this.config.dimensions.height*b,e=this.config.dimensions.height*b,f=(-this.config.dimensions.width+this.config.dimensions.margins.right)*b,g=(this.config.dimensions.width+this.config.dimensions.margins.left)*b,h=[Math.max(Math.min(c[0],g),f),Math.max(Math.min(c[1],e),d)];this.canvas.attr("transform","translate("+h+") scale("+b+")")},b.prototype._update=function(b){var c=this,d=a.svg.diagonal().projection(function(a){return[a.x,a.y]}),e=this.tree(this.root).reverse(),f=this.tree.links(e);e.forEach(function(a){a.y=100*a.depth});var g=this.svg.select(".canvas g").selectAll("g.node").data(e,function(a,b){return a.id||(a.id=++b)}),h=g.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+b.x+", "+b.y+")"});h.append("circle").attr("r",10).on("click",function(b,d){c._clickNode(b,d,a.select(this))}).on("mouseover",function(){a.select(this).classed({hover:!0})}).on("mouseout",function(){a.select(this).classed("selected")||a.select(this).classed({hover:!1})}).style("stroke",function(a){return c.color(a.pos)}),h.append("text").attr("y",function(a){return"root"==a.pos?-30:15}).attr("dy","14px").attr("lang",function(){return c.config.lang}).attr("text-anchor","middle").text(function(a){return a.value}).style("fill",function(a){return"root"==a.pos?"#CCC":"#333"}),h.append("text").attr("y",function(a){return"root"==a.pos?0:-30}).attr("dy","12px").attr("text-anchor","middle").attr("class","label").text(function(a){return a.relation});var i=g.transition().duration(this.config.duration).attr("transform",function(a){return"translate("+a.x+", "+a.y+")"});i.select("text.label").text(function(a){return a.relation}),i.select("circle").style("stroke",function(a){return c.color(a.pos)}).style("fill",function(){return"#FFF"});var j=this.svg.select(".canvas g").selectAll("path.link").data(f,function(a){return a.target.id});j.enter().insert("path","g").attr("class","link").style("stroke","#CCC").style("stroke-width","2px").style("fill","none").attr("d",function(){var a={x:b.x,y:b.y};return d({source:a,target:a})}),j.transition().duration(this.config.duration).attr("d",d),e.forEach(function(a){a.x0=a.x,a.y0=a.y})},b.prototype._clickNode=function(b,c,d){if(d.classed("selected"))return d.classed({selected:!1}),void(this.el.querySelector('span[data-id="'+b.id+'"]').className="");d.classed({selected:!0}),this.el.querySelector('span[data-id="'+b.id+'"]').className="selected";var e=[];if(this.svg.selectAll("circle").each(function(b){a.select(this).classed("selected")&&e.push(b)}),2==e.length){var f=b,g=f.id!=e[0].id?e[0]:e[1];f.id==g.parent.id||"root"==g.pos?(this.svg.selectAll("circle").each(function(){a.select(this).classed({selected:!1})}),console.log("Child is already assigned to this parent, or you're trying to move the root.")):this._isAncestor(g,f.id)?(this.svg.selectAll("circle").each(function(){a.select(this).classed({selected:!1})}),console.log("Trying to make an ancestor the child of one of its descendants.")):(console.log("valid move"),f.children=this._insertChild(f.children,g),g.parent.children=this._removeChild(g.parent.children,g),g.parent=f,g.head=f.id,this._update(f),this._checkConnection(g),this.svg.selectAll("circle").each(function(){a.select(this).classed({selected:!1})})),setTimeout(function(){this.el.querySelector('span[data-id="'+f.id+'"]').className="",this.el.querySelector('span[data-id="'+g.id+'"]').className=""}.bind(this),500)}},b.prototype._isAncestor=function(a,b){var c=a.children;if(c)for(var d=0,e=c.length;e>d;d++){if(c[d].id==b)return!0;if(this._isAncestor(c[d],b))return!0}return!1},b.prototype._insertChild=function(a,b){a||(a=[]);var c=0;for(c;c<a.length&&!(a[c].id>b.id);c++);return a.splice(c,0,b),a},b.prototype._removeChild=function(a,b){var c=0;for(c;c<a.length&&a[c].id!=b.id;c++);return a.splice(c,1),a},b.prototype._checkConnection=function(a){for(var b=0;b<this.answers;b++)if(a.id==this.answers[b].id){console.log(a.parent.id==this.answers[b].head?"correct connection":"wrong answer");break}},Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),b});