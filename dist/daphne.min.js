/*! daphne 2014-06-19 */
define(["d3"],function(a){"use strict";function b(a,b){return this.el=document.querySelector(a),this.options=b||{},null===this.el?(console.log("Could not find DOM object"),this):(this.init(),this)}return b.prototype.defaults={mode:"edit",lang:"grc",data:null,marginTop:50,marginRight:0,marginBottom:50,marginLeft:0,width:400,height:400,initialScale:.9,duration:500,include:null,exclude:null,config:null},b.prototype.init=function(){return this.config=this._extend({},this.defaults,this.options),this._configureSettings(this.options.config),this.data=this._convertData(this.config.data),this.render(),this},b.prototype._configureSettings=function(a){if("string"==typeof a){var b=new XMLHttpRequest;b.open("GET",a,!1),b.onload=function(){b.status>=200&&b.status<400?this.config.config=JSON.parse(b.responseText):console.log("Reached server but server error occured while trying to fetch data")}.bind(this),b.onerror=function(){console.log("Connection error while trying to fetch data.")},b.send()}else"object"==typeof a?this.config.config=a:"undefined"==typeof a&&(this.config.config={fields:[{name:"value",type:"text",label:"Value"},{name:"relation",type:"text",label:"Relation"}]})},b.prototype._extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},b.prototype._fetchData=function(){var a=new XMLHttpRequest;a.open("GET",this.config.dataSource,!0),a.onload=function(){if(a.status>=200&&a.status<400){this.data=this._convertData(JSON.parse(a.responseText).words);var b;window.CustomEvent?b=new CustomEvent("populated"):(b=document.createEvent("CustomEvent"),b.initEvent("populated",!0,!0)),this.el.dispatchEvent(b)}else console.log("Reached server but server error occured while trying to fetch data")}.bind(this),a.onerror=function(){console.log("Connection error while trying to fetch data.")},a.send()},b.prototype._convertData=function(a){this.answers=JSON.parse(JSON.stringify(a));for(var b=a.reduce(function(a,b){return a[b.id]=b,a},[]),c=0,d=0;d<a.length;d++){var e=a[d];if(void 0===b[e.head]){c=e.head;var f={id:c,value:"root",pos:"root"};a.push(f),b[c]=f;break}}"play"==this.config.mode&&(Object.keys(b).forEach(function(a){"root"!==b[a].pos&&(b[a].head=c)}),a.forEach(function(a){"root"!==a.pos&&(a.head=c)}));var g=[];return a.forEach(function(a){var c=b[a.head];c?(c.children||(c.children=[])).push(a):g.push(a)}),g},b.prototype.render=function(){var b=this;this.el.className="daphne",this.header=document.createElement("div"),this.header.className="sentence",this.el.appendChild(this.header),this.xmlLink=document.createElement("a"),this.xmlLink.href="#",this.xmlLink.className="export-link xml",this.xmlLink.appendChild(document.createTextNode("XML")),this.el.appendChild(this.xmlLink),this.footer=document.createElement("div"),this.footer.className="footer",this.el.appendChild(this.footer);for(var c=0;c<this.answers.length;c++){var d=document.createElement("span"),e=document.createTextNode(" ");d.innerHTML=this.answers[c].value,d.setAttribute("data-id",this.answers[c].id),this.header.appendChild(d),this.header.appendChild(e)}this.tree=a.layout.tree().nodeSize([100,50]),this.tree.separation(function(a,b){var c=a.value.length>a.relation.length?a.value.length:a.relation.length,d=b.value.length>b.relation.length?b.value.length:b.relation.length,e=.13;return Math.ceil(c*e+d*e/2)}),this.color=a.scale.ordinal().domain(["noun","verb","participle","adj","adverb","particle","conj","prep","pron","numeral","interjection","exclam","punct","article","root","_","unassigned"]).range(["#019292","#D15241","#8CD141","#4E6087","#8CD141","#FF881A","#754574","#149069","#523D5B","#812F0F","#F4BC78","#F4BC78","#1D78AA","#257008","#333","#999","#999"]),this.svg=a.select(this.el).append("svg").attr("class","svg-container").style("width",b.config.width+"px").style("height",b.config.height+"px").style("overflow","auto"),this.canvas=this.svg.append("g").attr("class","canvas"),this.canvas.append("g").attr("transform","translate("+b.config.width/2+", "+b.config.marginTop+") scale("+b.config.initialScale+")"),a.select(this.el.querySelector("svg")).call(a.behavior.zoom().scaleExtent([.5,5]).on("zoom",this._zoom.bind(this))).on("dblclick.zoom",null),this.root=this.data[0],this._update(this.root)},b.prototype._zoom=function(){var b=a.event.scale,c=a.event.translate,d=-this.config.height*b,e=this.config.height*b,f=(-this.config.width+this.config.marginRight)*b,g=(this.config.width+this.config.marginLeft)*b,h=[Math.max(Math.min(c[0],g),f),Math.max(Math.min(c[1],e),d)];this.canvas.attr("transform","translate("+h+") scale("+b+")")},b.prototype._update=function(b){var c=this,d=a.svg.diagonal().projection(function(a){return[a.x,a.y]}),e=this.tree(this.root).reverse(),f=this.tree.links(e);e.forEach(function(a){a.y=100*a.depth});var g=this.svg.select(".canvas g").selectAll("g.node").data(e,function(a){return a.id}),h=g.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+b.x+", "+b.y+")"});h.append("circle").attr("r",10).on("click",function(b,d){c._clickNode(b,d,a.select(this))}).on("dblclick",function(b,d){return"display"===c.config.mode?!1:void c._editNode(b,d,a.select(this))}).style("stroke",function(a){return c.color(a.pos)}),h.append("text").attr("y",function(a){return"root"==a.pos?-30:15}).attr("dy","14px").attr("lang",function(){return c.config.lang}).attr("text-anchor","middle").text(function(a){return a.value}).style("fill",function(a){return"root"==a.pos?"#CCC":"#333"}),h.append("text").attr("y",function(a){return"root"==a.pos?0:-30}).attr("dy","12px").attr("text-anchor","middle").attr("class","label").text(function(a){return a.relation});var i=g.transition().duration(this.config.duration).attr("transform",function(a){return"translate("+a.x+", "+a.y+")"});i.select("text.label").text(function(a){return a.relation}),i.select("circle").style("stroke",function(a){return c.color(a.pos)}).style("fill",function(b){return a.select(this).classed("match")?a.rgb(c.color(b.pos)).brighter():"#FFF"});var j=this.svg.select(".canvas g").selectAll("path.link").data(f,function(a){return a.target.id});j.enter().insert("path","g").attr("class","link").style("stroke","#CCC").style("stroke-width","2px").style("fill","none").attr("d",function(){var a={x:b.x,y:b.y};return d({source:a,target:a})}),j.transition().duration(this.config.duration).attr("d",d),e.forEach(function(a){a.x0=a.x,a.y0=a.y})},b.prototype._deselectNode=function(a,b){b.classed({selected:!1}),"root"!==a.pos&&(this.el.querySelector('span[data-id="'+a.id+'"]').className="")},b.prototype._selectNode=function(a,b){b.classed({selected:!0}),"root"!==a.pos&&(this.el.querySelector('span[data-id="'+a.id+'"]').className="selected")},b.prototype._deselectAllNodes=function(){var b=[];this.svg.selectAll("circle").each(function(c){b.push({d:c,node:a.select(this)})}),setTimeout(function(){for(var a=0;a<b.length;a++)this._deselectNode(b[a].d,b[a].node)}.bind(this),500)},b.prototype._clickNode=function(b,c,d){if(d.classed("selected"))return void this._deselectNode(b,d);this._selectNode(b,d);var e=[];if(this.svg.selectAll("circle").each(function(b){a.select(this).classed("selected")&&e.push(b)}),2==e.length){var f=b,g=f.id!=e[0].id?e[0]:e[1];if(this._validMove(g,f)&&(f.children=this._insertChild(f.children,g),g.parent.children=this._removeChild(g.parent.children,g),g.parent=f,g.head=f.id,this._update(f),"play"==this.config.mode)){var h=this.svg.selectAll("circle").filter(function(a){return a.id==g.id}),i=this._checkMatch(g,f);h.classed({match:i}),this._update(h),this._checkCompletion()&&console.log("complete!")}this._deselectAllNodes()}},b.prototype._editNode=function(){},b.prototype._validMove=function(a,b){return b.id===a.parent.id?(console.log("Child is already assigned to this parent."),!1):"root"===a.pos?(console.log("Cannot move root."),!1):this._isAncestor(a,b.id)?(console.log("Cannot make an ancestor the child of one of its descendants."),!1):(console.log("Valid Move"),!0)},b.prototype._isAncestor=function(a,b){var c=a.children;if(c)for(var d=0,e=c.length;e>d;d++){if(c[d].id==b)return!0;if(this._isAncestor(c[d],b))return!0}return!1},b.prototype._insertChild=function(a,b){a||(a=[]);var c=0;for(c;c<a.length&&!(a[c].id>b.id);c++);return a.splice(c,0,b),a},b.prototype._removeChild=function(a,b){var c=0;for(c;c<a.length&&a[c].id!=b.id;c++);return a.splice(c,1),a},b.prototype._checkMatch=function(a,b){if(!this.answers)return console.log("Cannot check connection without data to check against."),!1;for(var c,d=0;d<this.answers.length;d++)if(a.id==this.answers[d].id){c=b.id===this.answers[d].head;break}return console.log("connection was "+(c?"correct":"incorrect")),c},b.prototype._checkCompletion=function(){var a=!0,b=this,c=[],d=[],e=this.answers.reduce(function(a,b){return a[b.id]=b,a},[]);if(this.svg.selectAll("circle").each(function(f){"root"!==f.pos&&(a=f.parent.id==e[f.id].head&&a?!0:!1,f.parent.id==b.root.id&&(c.push(this),d.push(f)))}),a)for(var f=0;f<c.length;f++)this._update(d[f]);return a},Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),b});